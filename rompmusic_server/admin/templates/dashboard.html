{% extends "base.html" %}
{% block title %}RompMusic Admin - Dashboard{% endblock %}
{% block content %}
<div class="container">
    <nav style="margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem;">
        <img src="/logo.png" alt="RompMusic" width="32" height="32" style="vertical-align: middle;" />
        <a href="/server/dashboard">Dashboard</a> | <a href="/api/docs">API</a>
    </nav>
    <h1>RompMusic Admin</h1>
    <p>Logged in as {{ user.username }}</p>

    <div class="card">
        <h2>Library</h2>
        <div class="stats">
            <div class="stat"><span class="stat-value">{{ artists_count }}</span><br>Artists</div>
            <div class="stat"><span class="stat-value">{{ albums_count }}</span><br>Albums</div>
            <div class="stat"><span class="stat-value">{{ tracks_count }}</span><br>Tracks</div>
            <div class="stat"><span class="stat-value">{{ users_count }}</span><br>Users</div>
        </div>
        {% if auto_scan_interval_hours and auto_scan_interval_hours > 0 %}
        <p style="margin-top: 0.5rem; color: #64748b; font-size: 0.9rem;">Auto scan: every {{ auto_scan_interval_hours }} hour(s).</p>
        {% endif %}
        {% if beets_auto_interval_hours and beets_auto_interval_hours > 0 %}
        <p style="color: #64748b; font-size: 0.9rem;">Beets fetch-art: every {{ beets_auto_interval_hours }} hour(s).</p>
        {% endif %}
        {% if run_beets_after_scan %}
        <p style="color: #64748b; font-size: 0.9rem;">Beets fetch-art runs after each scan.</p>
        {% endif %}
        <p style="margin-top: 1rem;">
            <button id="scan-btn" onclick="startScan()">Scan Library</button>
        </p>
        <div id="scan-result"></div>
    </div>

    <div class="card">
        <h2>Users</h2>
        <p style="color: #94a3b8; font-size: 0.9rem;">Approve pending registrations or send password reset emails.</p>
        <div id="users-loading" style="color: #94a3b8;">Loading...</div>
        <div id="users-content" style="display: none; overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 0.5rem;">
                <thead>
                    <tr style="border-bottom: 1px solid #334155;">
                        <th style="text-align: left; padding: 0.5rem;">Username</th>
                        <th style="text-align: left; padding: 0.5rem;">Email</th>
                        <th style="text-align: left; padding: 0.5rem;">Status</th>
                        <th style="text-align: left; padding: 0.5rem;">Role</th>
                        <th style="text-align: left; padding: 0.5rem;">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-tbody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>Pending invitations</h2>
        <p style="color: #94a3b8; font-size: 0.9rem;">Invites not yet used. Resend the invite email if needed.</p>
        <div id="invitations-loading" style="color: #94a3b8;">Loading...</div>
        <div id="invitations-content" style="display: none; overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 0.5rem;">
                <thead>
                    <tr style="border-bottom: 1px solid #334155;">
                        <th style="text-align: left; padding: 0.5rem;">Email</th>
                        <th style="text-align: left; padding: 0.5rem;">Username</th>
                        <th style="text-align: left; padding: 0.5rem;">Expires</th>
                        <th style="text-align: left; padding: 0.5rem;">Actions</th>
                    </tr>
                </thead>
                <tbody id="invitations-tbody"></tbody>
            </table>
            <p id="invitations-empty" style="display: none; color: #64748b; margin-top: 0.5rem;">No pending invitations.</p>
        </div>
    </div>

    <div class="card">
        <h2>Invite user</h2>
        <p style="color: #94a3b8; font-size: 0.9rem;">Send an invitation email. If you set a username, their password will be the same as the username and the email will tell them both; if you leave username blank, they choose username and password when they open the signup link.</p>
        <form id="invite-form" style="margin-top: 0.5rem;">
            <p style="margin: 0.5rem 0;">
                <label>Email address <span style="color: #94a3b8;">(required)</span></label><br>
                <input type="email" name="invite_email" id="invite-email" required style="width: 20rem;">
            </p>
            <p style="margin: 0.5rem 0;">
                <label>Username <span style="color: #94a3b8;">(optional – if set, password is the same; they only activate via link)</span></label><br>
                <input type="text" name="invite_username" id="invite-username" placeholder="Leave blank for invitee to choose" style="width: 20rem;">
            </p>
            <p style="margin: 0.5rem 0;">
                <label>Personal message <span style="color: #94a3b8;">(optional – included in the invitation email)</span></label><br>
                <textarea name="invite_message" id="invite-message" rows="3" placeholder="Add a personal note for the invitee..." style="width: 100%; max-width: 28rem; resize: vertical;"></textarea>
            </p>
            <p style="margin-top: 1rem;">
                <button type="submit">Send invitation</button>
                <span id="invite-msg" style="margin-left: 1rem;"></span>
            </p>
        </form>
    </div>

    <div class="card">
        <h2>Server Settings</h2>
        <p style="color: #94a3b8; font-size: 0.9rem;">Registration, library schedule, public access, and API keys. Changes take effect immediately (scheduler re-reads intervals).</p>
        <div id="server-config-loading" style="color: #94a3b8;">Loading...</div>
        <div id="server-config-content" style="display: none;">
            <form id="server-settings-form" style="margin-top: 0.5rem;">
                <h3 style="font-size: 1rem; margin: 1rem 0 0.5rem 0; color: #cbd5e1;">Registration</h3>
                <p style="margin: 0.5rem 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="registration_enabled" id="server-registration-enabled">
                        <span>Allow new user registration</span>
                    </label>
                </p>
                <p style="margin: 0.5rem 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="registration_requires_approval" id="server-registration-approval">
                        <span>Require admin approval after email verification</span>
                    </label>
                </p>
                <h3 style="font-size: 1rem; margin: 1rem 0 0.5rem 0; color: #cbd5e1;">Public server</h3>
                <p style="margin: 0.5rem 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="public_server_enabled" id="server-public-enabled">
                        <span>Allow unauthenticated access (cookie-based recently played)</span>
                    </label>
                </p>
                <h3 style="font-size: 1rem; margin: 1rem 0 0.5rem 0; color: #cbd5e1;">Library schedule</h3>
                <p style="margin: 0.5rem 0;">
                    <label>Auto scan interval (hours, 0 = disabled)</label><br>
                    <input type="number" name="auto_scan_interval_hours" id="server-scan-interval" min="0" step="0.5" style="width: 6rem;">
                </p>
                <p style="margin: 0.5rem 0;">
                    <label>Beets fetch-art interval (hours, 0 = disabled)</label><br>
                    <input type="number" name="beets_auto_interval_hours" id="server-beets-interval" min="0" step="0.5" style="width: 6rem;">
                </p>
                <p style="margin: 0.5rem 0;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="run_beets_after_scan" id="server-run-beets-after-scan">
                        <span>Run beets fetch-art after each library scan</span>
                    </label>
                </p>
                <h3 style="font-size: 1rem; margin: 1rem 0 0.5rem 0; color: #cbd5e1;">API keys</h3>
                <p style="margin: 0.5rem 0;">
                    <label>Last.fm API key (leave blank or *** to keep current)</label><br>
                    <input type="password" name="api_key_lastfm" id="server-api-lastfm" placeholder="Optional" style="width: 20rem;">
                </p>
                <p style="margin: 0.5rem 0;">
                    <label>Beets API key (optional; leave blank to keep)</label><br>
                    <input type="password" name="api_key_beets" id="server-api-beets" placeholder="Optional" style="width: 20rem;">
                </p>
                <p style="margin-top: 1rem;">
                    <button type="submit">Save server settings</button>
                    <span id="server-settings-msg" style="margin-left: 1rem;"></span>
                </p>
            </form>
        </div>
    </div>

    <div class="card">
        <h2>Usage statistics</h2>
        <div id="stats-loading" style="color: #94a3b8;">Loading...</div>
        <div id="stats-content" style="display: none;">
            <p style="color: #cbd5e1;">Total users: <strong id="stats-users-total"></strong></p>
            <p style="color: #cbd5e1;">Pending approval: <strong id="stats-users-pending"></strong></p>
            <p style="color: #cbd5e1;">Total plays recorded: <strong id="stats-plays-total"></strong></p>
        </div>
    </div>

    <script>
    async function startScan() {
        const btn = document.getElementById('scan-btn');
        const result = document.getElementById('scan-result');
        btn.disabled = true;
        result.innerHTML = '<p style="color: #94a3b8;">Connecting to scan stream...</p>';

        try {
            const resp = await fetch('/server/scan/stream', { method: 'POST', credentials: 'same-origin' });
            if (!resp.ok) {
                result.innerHTML = '<p style="color: #f87171;">Scan failed: ' + resp.status + '</p>';
                btn.disabled = false;
                return;
            }

            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let lastData = null;
            let lastRender = 0;
            const renderInterval = 16;

            function render(data) {
                const status = (data.current_file || '').replace(/</g, '&lt;');
                const isStartup = data.total === 0;
                let html;
                if (isStartup) {
                    html = '<p style="color: #94a3b8; font-weight: 500;">' + status + '</p>' +
                        '<p style="color: #64748b; font-size: 0.85rem;">Initializing scan...</p>';
                } else {
                    const pct = Math.round(100 * data.processed / data.total);
                    html = '<p style="color: #94a3b8;">Processing: ' + data.processed + ' / ' + data.total + ' files (' + pct + '%)</p>' +
                        '<div style="background:#1e293b;border-radius:4px;height:8px;overflow:hidden;margin:0.5rem 0;"><div style="background:var(--accent);height:100%;width:' + pct + '%;transition:width 0.1s"></div></div>' +
                        '<p style="color: #64748b; font-size: 0.9rem;">' + status + '</p>' +
                        '<p style="color: #4a9eff;">Artists: ' + data.artists + ' &middot; Albums: ' + data.albums + ' &middot; Tracks: ' + data.tracks + '</p>';
                }
                result.innerHTML = html;
            }

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));
                        if (data.done) {
                            if (data.error) {
                                result.innerHTML = '<p style="color: #f87171;">Scan failed: ' + data.error.replace(/</g, '&lt;') + '</p>';
                            } else {
                                result.innerHTML = '<p style="color: #4ade80;">Scan complete! Reloading...</p>';
                                window.location.reload();
                            }
                            btn.disabled = false;
                            return;
                        }
                        lastData = data;
                        const now = performance.now();
                        const isStartup = data.total === 0;
                        if (isStartup || now - lastRender >= renderInterval || lastRender === 0) {
                            render(data);
                            lastRender = now;
                        }
                    }
                }
            }
            if (lastData) render(lastData);

            result.innerHTML = '<p style="color: #4ade80;">Scan complete! Reloading...</p>';
            window.location.reload();
        } catch (err) {
            result.innerHTML = '<p style="color: #f87171;">Scan error: ' + err.message + '</p>';
        } finally {
            btn.disabled = false;
        }
    }

    const API_BASE = '{{ api_base }}';
    const CLIENT_SETTING_LABELS = {
        group_artists_by_capitalization: 'Group artists with different capitalization',
        group_collaborations_by_primary: 'Group collaborations by primary artist',
        audio_format: 'Audio quality (format)',
        albums_artwork_first: 'Show albums with artwork first',
    };

    async function loadClientConfig() {
        const loading = document.getElementById('client-config-loading');
        const form = document.getElementById('client-config-form');
        const tbody = document.getElementById('client-config-body');
        try {
            const resp = await fetch(API_BASE + '/admin/client-config', { credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            const data = await resp.json();
            const cfg = data.client_settings || data;
            tbody.innerHTML = '';
            for (const [key, val] of Object.entries(cfg)) {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #334155';
                const label = CLIENT_SETTING_LABELS[key] || key;
                let defaultCell = '';
                if (key === 'audio_format') {
                    defaultCell = '<select name="default_' + key + '"><option value="original"' + (val.default === 'original' ? ' selected' : '') + '>original</option><option value="ogg"' + (val.default === 'ogg' ? ' selected' : '') + '>ogg</option></select>';
                } else {
                    defaultCell = '<select name="default_' + key + '"><option value="false"' + (val.default === false ? ' selected' : '') + '>Off</option><option value="true"' + (val.default === true ? ' selected' : '') + '>On</option></select>';
                }
                row.innerHTML = '<td style="padding: 0.5rem 0;">' + label + '</td>' +
                    '<td style="padding: 0.5rem 0;"><input type="checkbox" name="visible_' + key + '" ' + (val.visible ? 'checked' : '') + '></td>' +
                    '<td style="padding: 0.5rem 0;">' + defaultCell + '</td>';
                tbody.appendChild(row);
            }
            loading.style.display = 'none';
            form.style.display = 'block';
        } catch (e) {
            loading.innerHTML = '<span style="color: #f87171;">Failed to load: ' + e.message + '</span>';
        }
    }

    function setupClientConfigForm() {
        document.getElementById('client-config-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const msg = document.getElementById('client-config-msg');
        const cfg = {};
        for (const key of Object.keys(CLIENT_SETTING_LABELS)) {
            const visInput = form.querySelector('[name="visible_' + key + '"]');
            const defInput = form.querySelector('[name="default_' + key + '"]');
            if (visInput && defInput) {
                const defVal = defInput.tagName === 'SELECT' ? defInput.value : defInput.value === 'true';
                cfg[key] = { visible: visInput.checked, default: key === 'audio_format' ? defVal : defVal === 'true', allowed: ['original', 'ogg'] };
            }
        }
        try {
            const resp = await fetch(API_BASE + '/admin/client-config', {
                method: 'PUT',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_settings: cfg }),
            });
            if (!resp.ok) throw new Error(resp.status);
            msg.innerHTML = '<span style="color: #4ade80;">Saved.</span>';
            setTimeout(function() { msg.innerHTML = ''; }, 2000);
        } catch (err) {
            msg.innerHTML = '<span style="color: #f87171;">Save failed: ' + err.message + '</span>';
        }
    });
    }

    async function loadServerConfig() {
        const loading = document.getElementById('server-config-loading');
        const content = document.getElementById('server-config-content');
        try {
            const resp = await fetch(API_BASE + '/admin/server-config', { credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            const data = await resp.json();
            const ss = data.server_settings || {};
            document.getElementById('server-registration-enabled').checked = ss.registration_enabled !== false;
            document.getElementById('server-registration-approval').checked = ss.registration_requires_approval === true;
            document.getElementById('server-public-enabled').checked = ss.public_server_enabled === true;
            document.getElementById('server-scan-interval').value = data.auto_scan_interval_hours != null ? data.auto_scan_interval_hours : '';
            document.getElementById('server-beets-interval').value = data.beets_auto_interval_hours != null ? data.beets_auto_interval_hours : '';
            document.getElementById('server-run-beets-after-scan').checked = data.run_beets_after_scan === true;
            document.getElementById('server-api-lastfm').placeholder = (data.api_keys && data.api_keys.lastfm) ? '***' : 'Optional';
            document.getElementById('server-api-beets').placeholder = (data.api_keys && data.api_keys.beets) ? '***' : 'Optional';
            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (e) {
            loading.innerHTML = '<span style="color: #f87171;">Failed to load: ' + e.message + '</span>';
        }
    }

    function setupServerSettingsForm() {
        document.getElementById('server-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const msg = document.getElementById('server-settings-msg');
            const body = {
                registration_enabled: form.querySelector('[name="registration_enabled"]').checked,
                registration_requires_approval: form.querySelector('[name="registration_requires_approval"]').checked,
                public_server_enabled: form.querySelector('[name="public_server_enabled"]').checked,
                auto_scan_interval_hours: parseFloat(form.querySelector('[name="auto_scan_interval_hours"]').value) || 0,
                beets_auto_interval_hours: parseFloat(form.querySelector('[name="beets_auto_interval_hours"]').value) || 0,
                run_beets_after_scan: form.querySelector('[name="run_beets_after_scan"]').checked,
            };
            const lastfmVal = form.querySelector('[name="api_key_lastfm"]').value.trim();
            const beetsVal = form.querySelector('[name="api_key_beets"]').value.trim();
            if (lastfmVal || beetsVal) {
                body.api_keys = {};
                if (lastfmVal) body.api_keys.lastfm = lastfmVal;
                if (beetsVal) body.api_keys.beets = beetsVal;
            }
            try {
                const resp = await fetch(API_BASE + '/admin/server-config', {
                    method: 'PUT',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!resp.ok) throw new Error(resp.status);
                msg.innerHTML = '<span style="color: #4ade80;">Saved.</span>';
                setTimeout(function() { msg.innerHTML = ''; }, 2000);
                loadServerConfig();
            } catch (err) {
                msg.innerHTML = '<span style="color: #f87171;">Save failed: ' + err.message + '</span>';
            }
        });
    }

    async function loadStats() {
        const loading = document.getElementById('stats-loading');
        const content = document.getElementById('stats-content');
        try {
            const resp = await fetch(API_BASE + '/admin/stats', { credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            const data = await resp.json();
            document.getElementById('stats-users-total').textContent = data.users_total ?? 0;
            document.getElementById('stats-users-pending').textContent = data.users_pending_approval ?? 0;
            document.getElementById('stats-plays-total').textContent = data.plays_total ?? 0;
            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (e) {
            loading.innerHTML = '<span style="color: #f87171;">Failed to load: ' + e.message + '</span>';
        }
    }

    async function loadUsers() {
        const loading = document.getElementById('users-loading');
        const content = document.getElementById('users-content');
        const tbody = document.getElementById('users-tbody');
        try {
            const resp = await fetch(API_BASE + '/admin/users', { credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            const users = await resp.json();
            tbody.innerHTML = users.map(function(u) {
                const status = u.is_active ? '<span style="color: #4ade80;">Active</span>' : '<span style="color: #fbbf24;">Pending approval</span>';
                const role = u.is_admin ? 'Admin' : 'User';
                let actions = '';
                if (!u.is_active) {
                    actions += '<button type="button" class="user-approve" data-id="' + u.id + '" style="margin-right: 0.5rem;">Approve</button>';
                }
                actions += '<button type="button" class="user-pw-reset" data-id="' + u.id + '" style="margin-right: 0.5rem;">Send password reset</button>';
                actions += '<button type="button" class="user-resend-welcome" data-id="' + u.id + '">Resend welcome email</button>';
                return '<tr style="border-bottom: 1px solid #334155;"><td style="padding: 0.5rem;">' + escapeHtml(u.username) + '</td><td style="padding: 0.5rem;">' + escapeHtml(u.email) + '</td><td style="padding: 0.5rem;">' + status + '</td><td style="padding: 0.5rem;">' + role + '</td><td style="padding: 0.5rem;">' + actions + '</td></tr>';
            }).join('');
            loading.style.display = 'none';
            content.style.display = 'block';
            tbody.querySelectorAll('.user-approve').forEach(function(btn) {
                btn.addEventListener('click', function() { approveUser(parseInt(btn.getAttribute('data-id'), 10)); });
            });
            tbody.querySelectorAll('.user-pw-reset').forEach(function(btn) {
                btn.addEventListener('click', function() { sendPasswordReset(parseInt(btn.getAttribute('data-id'), 10)); });
            });
            tbody.querySelectorAll('.user-resend-welcome').forEach(function(btn) {
                btn.addEventListener('click', function() { resendWelcomeEmail(parseInt(btn.getAttribute('data-id'), 10)); });
            });
        } catch (e) {
            loading.innerHTML = '<span style="color: #f87171;">Failed to load: ' + escapeHtml(e.message) + '</span>';
        }
    }

    async function loadInvitations() {
        const loading = document.getElementById('invitations-loading');
        const content = document.getElementById('invitations-content');
        const tbody = document.getElementById('invitations-tbody');
        const empty = document.getElementById('invitations-empty');
        try {
            const resp = await fetch(API_BASE + '/admin/invitations', { credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            const invitations = await resp.json();
            if (invitations.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
            } else {
                empty.style.display = 'none';
                tbody.innerHTML = invitations.map(function(inv) {
                    const expires = inv.expires_at ? new Date(inv.expires_at).toLocaleDateString() : '—';
                    return '<tr style="border-bottom: 1px solid #334155;"><td style="padding: 0.5rem;">' + escapeHtml(inv.email) + '</td><td style="padding: 0.5rem;">' + escapeHtml(inv.username || '—') + '</td><td style="padding: 0.5rem;">' + escapeHtml(expires) + '</td><td style="padding: 0.5rem;"><button type="button" class="invitation-resend" data-id="' + inv.id + '">Resend invite email</button></td></tr>';
                }).join('');
                tbody.querySelectorAll('.invitation-resend').forEach(function(btn) {
                    btn.addEventListener('click', function() { resendInviteEmail(parseInt(btn.getAttribute('data-id'), 10)); });
                });
            }
            loading.style.display = 'none';
            content.style.display = 'block';
        } catch (e) {
            loading.innerHTML = '<span style="color: #f87171;">Failed to load: ' + escapeHtml(e.message) + '</span>';
        }
    }
    async function resendInviteEmail(id) {
        try {
            const resp = await fetch(API_BASE + '/admin/invitations/' + id + '/resend', { method: 'POST', credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            const data = await resp.json();
            alert(data.message || 'Sent.');
        } catch (e) { alert('Failed: ' + e.message); }
    }
    function escapeHtml(s) { return (s || '').toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    async function approveUser(id) {
        try {
            const resp = await fetch(API_BASE + '/admin/users/' + id + '/approve', { method: 'POST', credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            loadUsers();
        } catch (e) { alert('Failed: ' + e.message); }
    }
    async function sendPasswordReset(id) {
        try {
            const resp = await fetch(API_BASE + '/admin/users/' + id + '/send-password-reset', { method: 'POST', credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            const data = await resp.json();
            alert(data.message || 'Sent.');
        } catch (e) { alert('Failed: ' + e.message); }
    }
    async function resendWelcomeEmail(id) {
        try {
            const resp = await fetch(API_BASE + '/admin/users/' + id + '/resend-welcome', { method: 'POST', credentials: 'same-origin' });
            if (!resp.ok) throw new Error(resp.status);
            const data = await resp.json();
            alert(data.message || 'Sent.');
        } catch (e) { alert('Failed: ' + e.message); }
    }

    function setupInviteForm() {
        document.getElementById('invite-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const msg = document.getElementById('invite-msg');
            const email = form.querySelector('[name="invite_email"]').value.trim();
            const username = form.querySelector('[name="invite_username"]').value.trim();
            const message = form.querySelector('[name="invite_message"]').value.trim();
            const body = { email: email };
            if (username) body.username = username;
            if (message) body.message = message;
            msg.innerHTML = '';
            try {
                const resp = await fetch(API_BASE + '/admin/invite', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await resp.json().catch(function() { return {}; });
                if (!resp.ok) {
                    msg.innerHTML = '<span style="color: #f87171;">' + (data.detail || resp.status) + '</span>';
                    return;
                }
                msg.innerHTML = '<span style="color: #4ade80;">' + (data.message || 'Sent.') + '</span>';
                form.reset();
                loadUsers();
                loadInvitations();
                setTimeout(function() { msg.innerHTML = ''; }, 3000);
            } catch (err) {
                msg.innerHTML = '<span style="color: #f87171;">' + err.message + '</span>';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadClientConfig();
        setupClientConfigForm();
        loadServerConfig();
        setupServerSettingsForm();
        loadUsers();
        loadInvitations();
        loadStats();
        setupInviteForm();
    });
    </script>

    <div class="card">
        <h2>Client Settings Policy</h2>
        <p style="color: #94a3b8; font-size: 0.9rem;">Control which settings are visible to app users and their defaults. When hidden, the default applies to all users.</p>
        <div id="client-config-loading" style="color: #94a3b8;">Loading...</div>
        <form id="client-config-form" style="display: none; margin-top: 1rem;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="border-bottom: 1px solid #334155;">
                        <th style="text-align: left; padding: 0.5rem 0;">Setting</th>
                        <th style="text-align: left; padding: 0.5rem 0;">Visible to users</th>
                        <th style="text-align: left; padding: 0.5rem 0;">Default</th>
                    </tr>
                </thead>
                <tbody id="client-config-body"></tbody>
            </table>
            <p style="margin-top: 1rem;">
                <button type="submit">Save</button>
                <span id="client-config-msg" style="margin-left: 1rem;"></span>
            </p>
        </form>
    </div>

    <div class="card">
        <h2>Quick Links</h2>
        <p><a href="/api/docs">API Documentation (Swagger)</a></p>
        <p><a href="/api/redoc">API Documentation (ReDoc)</a></p>
    </div>
</div>
{% endblock %}
