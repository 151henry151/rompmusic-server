{% extends "base.html" %}
{% block title %}RompMusic Admin - Dashboard{% endblock %}
{% block content %}
<div class="container">
    <nav style="margin-bottom: 2rem;">
        <a href="/server/dashboard">Dashboard</a> | <a href="/api/docs">API</a>
    </nav>
    <h1>RompMusic Admin</h1>
    <p>Logged in as {{ user.username }}</p>

    <div class="card">
        <h2>Library</h2>
        <div class="stats">
            <div class="stat"><span class="stat-value">{{ artists_count }}</span><br>Artists</div>
            <div class="stat"><span class="stat-value">{{ albums_count }}</span><br>Albums</div>
            <div class="stat"><span class="stat-value">{{ tracks_count }}</span><br>Tracks</div>
            <div class="stat"><span class="stat-value">{{ users_count }}</span><br>Users</div>
        </div>
        <p style="margin-top: 1rem;">
            <button id="scan-btn" onclick="startScan()">Scan Library</button>
        </p>
        <div id="scan-result"></div>
    </div>

    <script>
    async function startScan() {
        const btn = document.getElementById('scan-btn');
        const result = document.getElementById('scan-result');
        btn.disabled = true;
        result.innerHTML = '<p style="color: #94a3b8;">Connecting to scan stream...</p>';

        try {
            const resp = await fetch('/server/scan/stream', { method: 'POST', credentials: 'same-origin' });
            if (!resp.ok) {
                result.innerHTML = '<p style="color: #f87171;">Scan failed: ' + resp.status + '</p>';
                btn.disabled = false;
                return;
            }

            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let lastData = null;
            let lastRender = 0;
            const renderInterval = 16;

            function render(data) {
                const status = (data.current_file || '').replace(/</g, '&lt;');
                const isStartup = data.total === 0;
                let html;
                if (isStartup) {
                    html = '<p style="color: #94a3b8; font-weight: 500;">' + status + '</p>' +
                        '<p style="color: #64748b; font-size: 0.85rem;">Initializing scan...</p>';
                } else {
                    const pct = Math.round(100 * data.processed / data.total);
                    html = '<p style="color: #94a3b8;">Processing: ' + data.processed + ' / ' + data.total + ' files (' + pct + '%)</p>' +
                        '<div style="background:#1e293b;border-radius:4px;height:8px;overflow:hidden;margin:0.5rem 0;"><div style="background:var(--accent);height:100%;width:' + pct + '%;transition:width 0.1s"></div></div>' +
                        '<p style="color: #64748b; font-size: 0.9rem;">' + status + '</p>' +
                        '<p style="color: #4a9eff;">Artists: ' + data.artists + ' &middot; Albums: ' + data.albums + ' &middot; Tracks: ' + data.tracks + '</p>';
                }
                result.innerHTML = html;
            }

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));
                        if (data.done) {
                            result.innerHTML = '<p style="color: #4ade80;">Scan complete! Reloading...</p>';
                            window.location.reload();
                            return;
                        }
                        lastData = data;
                        const now = performance.now();
                        const isStartup = data.total === 0;
                        if (isStartup || now - lastRender >= renderInterval || lastRender === 0) {
                            render(data);
                            lastRender = now;
                        }
                    }
                }
            }
            if (lastData) render(lastData);

            result.innerHTML = '<p style="color: #4ade80;">Scan complete! Reloading...</p>';
            window.location.reload();
        } catch (err) {
            result.innerHTML = '<p style="color: #f87171;">Scan error: ' + err.message + '</p>';
        } finally {
            btn.disabled = false;
        }
    }
    </script>

    <div class="card">
        <h2>Quick Links</h2>
        <p><a href="/api/docs">API Documentation (Swagger)</a></p>
        <p><a href="/api/redoc">API Documentation (ReDoc)</a></p>
    </div>
</div>
{% endblock %}
